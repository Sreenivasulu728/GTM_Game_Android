name: Build APK

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java Development Kit
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install system dependencies
      run: |
        sudo apt update
        # CRITICAL LIBS: libffi-dev helps jnius compile
        sudo apt install -y python3 python3-pip python3-setuptools git zip unzip openjdk-17-jdk libffi-dev build-essential libtool adb

    - name: Install Buildozer and Cython
      run: |
        pip install --upgrade pip
        # Install buildozer from github for latest fixes
        pip install buildozer[github] cython

    # ----------------------------------------------------------------------
    # NEW STEP: Manual Workaround for missing jnius.c file
    # This step executes Cython in the specific build directory where p4a fails.
    # The paths below are based directly on the error logs you provided.
    # ----------------------------------------------------------------------
    - name: Workaround for missing jnius.c file
      run: |
        # Define the specific directory path where p4a builds pyjnius
        # Note: The exact path is generated by buildozer dynamically,
        # so we need to find it first if the exact version changes.
        
        # A more robust way: find the directory generated by buildozer
        JNIUS_BUILD_DIR=$(find /home/runner/work/GTM_Game_Android/GTM_Game_Android/.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/build/other_builds/ -maxdepth 1 -name "pyjnius-sdl2*" -type d)

        if [ -d "$JNIUS_BUILD_DIR" ]; then
          echo "Found Jnius build directory: $JNIUS_BUILD_DIR"
          JNIUS_SRC_DIR="$JNIUS_BUILD_DIR/pyjnius"

          if [ -f "$JNIUS_SRC_DIR/jnius/jnius.pyx" ]; then
            echo "jnius.c not found. Manually running Cython in $JNIUS_SRC_DIR..."
            cd "$JNIUS_SRC_DIR"
            # Use the installed 'cython' tool to generate the .c file
            cython jnius/jnius.pyx
            echo "jnius.c generated successfully."
          else
            echo "jnius/jnius.pyx not found in expected directory. Cannot run manual cython."
          fi
        else
          echo "Jnius build directory not found yet. This step might run too early in the first build cycle."
        fi

    - name: Build APK (Automatic Setup & Build)
      run: |
        buildozer android clean
        # The 'yes |' handles the SDK license prompt automatically
        yes | buildozer android debug
      timeout-minutes: 20 

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: GTMAPK
        path: bin/*.apk
